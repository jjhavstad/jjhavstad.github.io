
<!DOCTYPE html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://www.paypalobjects.com/api/checkout.js"></script>
    <link rel="stylesheet" href="checkout.css">
</head>

<body>

<h2>21 Mr. Merch</h2>

<a id="venmo-pay" class="button js-button" role="button" href="https://venmo.com/v2/paypal/checkout?lsat=12345\&uuid=ABCDE">venmo</a>

<p id="venmo-pay-status">Ready</p>

<script>
    var startTime = 0;
    document.getElementById('venmo-pay').addEventListener("click", function(e) {
        requestOrderId();
        startTime = Date.now();
    });

    function requestOrderId() {
        const token = "PAYID-LVAMXNI15H26688T68737947";
        initSocket(function(event) {
            console.log(`Sending: ${token}`);
            sendOrderId(token);
            (async () => {
                await setTimeout(sendHeartbeat, 1000);
            })()
        });
    }

    function sendHeartbeat() {
        let now = Date.now();
        let delta = now - startTime;
        console.log(`Sending heartbeat at time: +${delta}`);
        socket.send(now);
        (async () => {
            await setTimeout(sendHeartbeat, 1000);
        })()
    }

    var socket;
    function initSocket(onopen) {
       socket = new WebSocket("wss://localhost:8001");

       socket.onopen = onopen;

       socket.onmessage = function(event) {
         console.log(`Received: ${event.data}`);
         parseInput(event.data);
       };

       socket.onclose = function(event) {
         console.log('[close] Connection died');
         (async () => {
             await setTimeout(tryToReopenSocket(socket), 3000);
         })()
       };

       socket.onerror = function(error) {
         console.log(`[error] ${error.message}`);
       };

       return socket;
    }

    function tryToReopenSocket(socket) {
       socket = initSocket(socket.onopen);
    }

    function sendOrderId(orderId) {
        document.getElementById("venmo-pay-status").innerHTML = "Waiting...";
        let data = {type: "orderIdWithAddress", value: {orderId: orderId}}
        socket.send(data);
    }

    function parseInput(input) {
        let result = JSON.parse(input);
        if (result.type == "orderCompleteMessage") {
          let value = result.value;
          document.getElementById("venmo-pay-status").innerHTML = "Finished with order: " + value.orderId;
        }
    }
    </script>
</body>
